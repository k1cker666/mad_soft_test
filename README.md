# Тестовое задание
Сервис для загрузки, просмотра, удаления изображений.

## Техническое задание
Разработайте веб-приложение на Python, используя FastAPI, которое предоставляет API для работы с коллекцией мемов. Приложение должно состоять из двух сервисов: сервис с публичным API с бизнес-логикой и сервис для работы с медиа-файлами, используя S3-совместимое хранилище (н-р, MinIO).     

__Функциональность:__

- GET /memes: Получить список всех мемов (с пагинацией).
- GET /memes/{id}: Получить конкретный мем по его ID.
- POST /memes: Добавить новый мем (с картинкой и текстом).
- PUT /memes/{id}: Обновить существующий мем.                                        
- DELETE /memes/{id}: Удалить мем. 

__Требования:__

- Используйте реляционную СУБД для хранения данных.
- Обеспечьте обработку ошибок и валидацию входных данных.
- Используйте Swagger/OpenAPI для документирования API.
- Напишите хотя бы несколько unit-тестов для проверки основной функциональности.
- Напишите Readme, из которого понятна функциональность проекта и инструкция по локальному запуску для разработки.
- Проект должен состоять минимум из: 1 сервис с публичным API, 1 сервис с приватным API для изображений, 1 сервис СУБД, 1 сервис S3-storage.
- Напишите docker-compose.yml для запуска проекта.

## Функциональность проекта
- Запрос на получение списка изображений:

  Сервис публичного API обращается к базе данных и возвращает список изображений с их id, file_name, caption с пагинацией.
- Запрос на получение конкретного изображения:

  Сервис публичного API проверяет есть изображение с таким id, если изображение есть, то собращается к приватному API и возвращает изображение по имени файла, иначе сервис сообщает, что такое изображение не найдено.
- Запрос на загрузку изображения:

  Сервис публичного API проверяет, уникальное ли имя у изображения, если имя уникальное, то изображение отправляется в приватный API и загружается в S3 хранилище и затем в базу данных, иначе сообщает пользователю, что изображение с таким названием уже существует.

- Запрос на обновление изображения:
  Сервис публичного API проверяет есть ли изображение в базе данных с поданным id, заменяет файл в S3 хранилище и информацию в базе данных. В теле запроса необходимо также указыть описание для изображения. Если изображение с поданным id отсутствует, то сервис вернёт сообщение, что изображение отсутствует.

- Запрос на удаление изображения:
  Сервис публичного API также проверяет id, и либо удаляет данные из S3 хранилища и базы данных, либо сообщает, что такое изображение отсутствует.


## Хранилища
__PostgreSQL:__

  В базе данных все хранится в одной таблице memes с полями:
  - id - номер изображения, первичный ключ.
  - file_name - название изображения, ограничено длиной 20 символов.
  - caption - описание к изображению, ограничено длиной 500 символов.

  Таблица также индексируется по полю file_name.

__S3 совместимое хранилище MinIO:__

  Хранит в себе изображения сервиса.


## Локальный запуск
Сначала необходимо клонировать репозиторий: 
```
git clone https://github.com/k1cker666/mad_soft_test.git
```

Затем в корне проекта завести 3 файла переменных 
.env, чтобы докер смог получить переменные для конфигурации контейнеров: 
```
PSQL_DBNAME=postgres
PSQL_USER=postgres
PSQL_HOST=postgres
PSQL_PASSWORD=postgres
PSQL_PORT=5001
PSQL_ECHO=false
MINIO_ENDPOINT=minio:9000
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
MINIO_BUCKET_NAME=test-bucket
MINIO_VOLUMES=/mnt/data
```

.psql_env, чтобы pydantic мог собрать переменные для работы сервиса публичного API:
```
PSQL_DBNAME=postgres
PSQL_USER=postgres
PSQL_HOST=postgres
PSQL_PASSWORD=postgres
PSQL_PORT=5001
PSQL_ECHO=false
```

.minio_env, чтобы pydantic мог собрать переменные для работы сервиса приватного API:
```
MINIO_ENDPOINT=minio:9000
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
MINIO_BUCKET_NAME=test-bucket
MINIO_VOLUMES=/mnt/data
```

Далее необходимо собрать контейнер сервиса командой:
```
docker-compose up -d
```

Адреса для обращений:

http://localhost:8000/docs/ - интерактивная документация API

http://localhost:9090 - консоль управления хранилища MinIO

Также для обращения доступна база данных по порту 5001

### Для локальной разработки после клонирования репозитория необходимо выполнить следующие 3 шага:

В корне проекта нужно создать виртуальное окружение и активировать его:
```
python3 -m venv .venv
source .venv/bin/activate
```

Установить poetry и зависимости проекта:
```
pip install poetry==1.8.3
poetry install --no-root
```

Установить хуки для коммитов:
```
pre-commit install -c tools/.pre-commit-config.yaml
```

## Тесты
Для проведения тестов необходимо запустить контейнер и затем использовать команду: 
```
pytest -v
```
Таким образом будут проверены методы сервиса и заполнены хранилища четырьмя изображениями.

## Стек технологий:
1. Poetry
  
   Все зависимости проекта контролируются с помощью Poetry.
2. Pre-commit
  
   Сконфигурирован pre-commit файл, который проверяет оформление написанного кода по стилистическим правилам PEP8.
   - Flake8: проверяет код на стилистические ошибки.
   - Black: форматтер, который проверяет весь код.
   - Isort: форматтер, который проверяет правильность написания импортов.
3. Pytest

   Тестирование методов и функций проекта проводилось с помощью Pytest.
4. FastAPI

   На фреймворке FastAPI реализованы серсисы публичного и приватного API.
5. SQLAlchemy

   С помощью SQLAlchemy сервис публичного API обращается к базе данных PostgreSQL.
6. Docker

    С помощью Docker были собраны образы проекта.
7. Docker-compose

   С помощь Docker-compose был собран контейнер проекта, а именно:
    - Контейнер public_api
    - Контейнер private_backend
    - Контейнер minio, локальное S3 совместимое хранилище
    - Контейнер psql_db, локальная база данных PostgreSQL
